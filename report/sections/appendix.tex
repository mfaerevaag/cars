%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../report"
%%% End:

TODO!

\subsection{Barrier.sync() with semaphores}
\label{sub:app-barr-sync}
\begin{java}
public void sync() throws Exception {
	this.mutex.P();

	if (this.active) {
		// 1st - all cars must arrive ("incoming")
		this.incomingCount++;

		if (this.incomingCount < this.threshold) { // All cars, except one
			this.mutex.V();
			this.barrierIncoming.P();
		} else { // Final car needed to start a new round
			this.free(this.incomingCount - 1, BarrierSelector.INCOMING); // calls the relevant barrier-semaphore (leavingCount-1) times
			this.incomingCount = 0;
			this.mutex.V();
		}
		// 2nd - all cars must leave ("leaving")
		this.mutex.P();
		this.leavingCount++;

		if (this.leavingCount < this.threshold) {
			this.mutex.V();
			this.barrierLeaving.P();
		} else {
			this.free(this.leavingCount - 1, BarrierSelector.LEAVING); // calls the relevant barrier-semaphore (leavingCount-1) times
			this.leavingCount = 0;
			this.mutex.V();
		}

	} else {
		this.mutex.V();
	}
}
\end{java}